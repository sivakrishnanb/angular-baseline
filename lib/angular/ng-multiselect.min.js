angular.module("multi-select",["ng"]).directive("multiSelect",["$sce","$timeout",function(a,b){return{restrict:"AE",replace:!0,scope:{inputModel:"=",outputModel:"=",buttonLabel:"@",defaultLabel:"@",directiveId:"@",helperElements:"@",isDisabled:"=",itemLabel:"@",maxLabels:"@",orientation:"@",selectionMode:"@",tickProperty:"@",disableProperty:"@",groupProperty:"@",maxHeight:"@",onClose:"&",onItemClick:"&",onOpen:"&"},template:'<span class="multiSelect inlineBlock"><button type="button" class="button multiSelectButton" ng-click="toggleCheckboxes( $event ); refreshSelectedItems(); refreshButton();" ng-bind-html="varButtonLabel"></button><div class="checkboxLayer"><form><div class="helperContainer" ng-if="displayHelper( \'filter\' ) || displayHelper( \'all\' ) || displayHelper( \'none\' ) || displayHelper( \'reset\' )"><div class="line" ng-if="displayHelper( \'all\' ) || displayHelper( \'none\' ) || displayHelper( \'reset\' )"><button type="button" ng-click="select( \'all\',   $event );"    class="helperButton ThGreenButton" ng-if="!isDisabled && displayHelper( \'all\' )">   &#10003;&nbsp; Select All</button> <button type="button" ng-click="select( \'none\',  $event );"   class="helperButton ThGreenButton" ng-if="!isDisabled && displayHelper( \'none\' )">  &times;&nbsp; Select None</button><button type="button" ng-click="select( \'reset\', $event );"  class="helperButton" ng-if="!isDisabled && displayHelper( \'reset\' )" style="float:right">&#8630;&nbsp; Reset</button></div><div class="line" style="position:relative" ng-if="displayHelper( \'filter\' )"><!--<input placeholder="Search..." type="text" ng-click="select( \'filter\', $event )" ng-model="inputLabel.labelFilter" ng-change="updateFilter();$scope.getFormElements();" class="inputFilter" />--><button type="button" class="clearButton" ng-click="inputLabel.labelFilter=\'\';updateFilter();prepareGrouping();prepareIndex();select( \'clear\', $event )">&times;</button> </div></div><div class="checkBoxContainer" style="{{setHeight();}}"><div ng-repeat="item in filteredModel | filter:removeGroupEndMarker" class="multiSelectItem"ng-class="{selected: item[ tickProperty ], horizontal: orientationH, vertical: orientationV, multiSelectGroup:item[ groupProperty ], disabled:itemIsDisabled( item )}"ng-click="syncItems( item, $event, $index );"ng-mouseleave="removeFocusStyle( tabIndex );"><div class="acol" ng-if="item[ spacingProperty ] > 0" ng-repeat="i in numberToArray( item[ spacingProperty ] ) track by $index">&nbsp;</div><div class="acol"><label><input class="checkbox focusable" type="checkbox" ng-disabled="itemIsDisabled( item )" ng-checked="item[ tickProperty ]" ng-click="syncItems( item, $event, $index )" /><span ng-class="{disabled:itemIsDisabled( item )}" ng-bind-html="writeLabel( item, \'itemLabel\' )"></span></label></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tickMark" ng-if="item[ groupProperty ] !== true && item[ tickProperty ] === true">&#10004;</span></div></div></form></div></span>',link:function(c,d,e){c.backUp=[],c.varButtonLabel="",c.scrolled=!1,c.spacingProperty="",c.indexProperty="",c.checkBoxLayer="",c.orientationH=!1,c.orientationV=!0,c.filteredModel=[],c.inputLabel={labelFilter:""},c.selectedItems=[],c.formElements=[],c.tabIndex=0,c.clickedItem=null,prevTabIndex=0,helperItems=[],helperItemsLength=0,c.setHeight=function(){return"undefined"!=typeof c.maxHeight?"max-height: "+c.maxHeight+"; overflow-y:scroll":void 0},c.numberToArray=function(a){return new Array(a)},c.updateFilter=function(){c.filteredModel=[];var a=0;if("undefined"==typeof c.inputModel)return[];for(a=c.inputModel.length-1;a>=0;a--){"undefined"!=typeof c.inputModel[a][c.groupProperty]&&c.inputModel[a][c.groupProperty]===!1&&c.filteredModel.push(c.inputModel[a]);var d=!1;if("undefined"==typeof c.inputModel[a][c.groupProperty]){for(var e in c.inputModel[a])if("boolean"!=typeof c.inputModel[a][e]&&String(c.inputModel[a][e]).toUpperCase().indexOf(c.inputLabel.labelFilter.toUpperCase())>=0){d=!0;break}d===!0&&c.filteredModel.push(c.inputModel[a])}"undefined"!=typeof c.inputModel[a][c.groupProperty]&&c.inputModel[a][c.groupProperty]===!0&&("undefined"!=typeof c.filteredModel[c.filteredModel.length-1][c.groupProperty]&&c.filteredModel[c.filteredModel.length-1][c.groupProperty]===!1?c.filteredModel.pop():c.filteredModel.push(c.inputModel[a]))}c.filteredModel.reverse(),b(function(){c.getFormElements()},0)},c.getFormElements=function(){c.formElements=[];for(var a=0;a<d[0].getElementsByTagName("FORM")[0].elements.length;a++)c.formElements.push(d[0].getElementsByTagName("FORM")[0].elements[a])},c.isGroupMarker=function(a,b){return"undefined"!=typeof a[c.groupProperty]&&a[c.groupProperty]===b?!0:!1},c.removeGroupEndMarker=function(a){return"undefined"!=typeof a[c.groupProperty]&&a[c.groupProperty]===!1?!1:!0},c.displayHelper=function(a){if(e.selectionMode&&"SINGLE"===c.selectionMode.toUpperCase()){switch(a.toUpperCase()){case"ALL":return!1;case"NONE":return!1;case"RESET":if("undefined"==typeof e.helperElements)return!0;if(e.helperElements&&c.helperElements.toUpperCase().indexOf("RESET")>=0)return!0;break;case"FILTER":if("undefined"==typeof e.helperElements)return!0;if(e.helperElements&&c.helperElements.toUpperCase().indexOf("FILTER")>=0)return!0}return!1}return"undefined"==typeof e.helperElements?!0:e.helperElements&&c.helperElements.toUpperCase().indexOf(a.toUpperCase())>=0?!0:!1},c.syncItems=function(a,b,d){if(b.preventDefault(),b.stopPropagation(),"undefined"!=typeof e.disableProperty&&a[c.disableProperty]===!0)return!1;if("undefined"!=typeof e.isDisabled&&c.isDisabled===!0)return!1;if("undefined"!=typeof a[c.groupProperty]&&a[c.groupProperty]===!1)return!1;if(index=c.filteredModel.indexOf(a),"undefined"!=typeof a[c.groupProperty]&&a[c.groupProperty]===!0){if(e.selectionMode&&"SINGLE"===c.selectionMode.toUpperCase())return!1;var f,g,h=0,i=c.filteredModel.length-1,j=[],k=0;for(f=index;f<c.filteredModel.length&&!(0===k&&f>index);f++)if("undefined"!=typeof c.filteredModel[f][c.groupProperty]&&c.filteredModel[f][c.groupProperty]===!0)0===j.length&&(h=f+1),k+=1;else if("undefined"!=typeof c.filteredModel[f][c.groupProperty]&&c.filteredModel[f][c.groupProperty]===!1){if(k-=1,j.length>0&&0===k){var l=!0;for(i=f,g=0;g<j.length;g++)if("undefined"!=typeof j[g][c.tickProperty]&&j[g][c.tickProperty]===!1){l=!1;break}if(l===!0)for(g=h;i>=g;g++)"undefined"==typeof c.filteredModel[g][c.groupProperty]&&("undefined"==typeof e.disableProperty?(c.filteredModel[g][c.tickProperty]=!1,inputModelIndex=c.filteredModel[g][c.indexProperty],c.inputModel[inputModelIndex][c.tickProperty]=!1):c.filteredModel[g][c.disableProperty]!==!0&&(c.filteredModel[g][c.tickProperty]=!1,inputModelIndex=c.filteredModel[g][c.indexProperty],c.inputModel[inputModelIndex][c.tickProperty]=!1));else for(g=h;i>=g;g++)"undefined"==typeof c.filteredModel[g][c.groupProperty]&&("undefined"==typeof e.disableProperty?(c.filteredModel[g][c.tickProperty]=!0,inputModelIndex=c.filteredModel[g][c.indexProperty],c.inputModel[inputModelIndex][c.tickProperty]=!0):c.filteredModel[g][c.disableProperty]!==!0&&(c.filteredModel[g][c.tickProperty]=!0,inputModelIndex=c.filteredModel[g][c.indexProperty],c.inputModel[inputModelIndex][c.tickProperty]=!0))}}else j.push(c.filteredModel[f])}else{if(e.selectionMode&&"SINGLE"===c.selectionMode.toUpperCase()){for(f=0;f<c.filteredModel.length;f++)c.filteredModel[f][c.tickProperty]=!1;for(f=0;f<c.inputModel.length;f++)c.inputModel[f][c.tickProperty]=!1;c.filteredModel[index][c.tickProperty]=!0,c.toggleCheckboxes(b)}else c.filteredModel[index][c.tickProperty]=!c.filteredModel[index][c.tickProperty];inputModelIndex=c.filteredModel[index][c.indexProperty],c.inputModel[inputModelIndex][c.tickProperty]=c.filteredModel[index][c.tickProperty]}c.clickedItem=angular.copy(a),prevTabIndex=c.tabIndex,c.tabIndex=d+helperItemsLength,b.target.focus(),c.removeFocusStyle(prevTabIndex),c.setFocusStyle(c.tabIndex)},c.refreshSelectedItems=function(){c.selectedItems=[],angular.forEach(c.inputModel,function(a){"undefined"!=typeof a&&"undefined"==typeof a[c.groupProperty]&&a[c.tickProperty]===!0&&c.selectedItems.push(a)})},c.refreshOutputModel=function(){"undefined"!=typeof e.outputModel&&(c.outputModel=angular.copy(c.selectedItems),angular.forEach(c.outputModel,function(a){delete a[c.indexProperty],delete a[c.spacingProperty]}))},c.refreshButton=function(){if(c.varButtonLabel="",ctr=0,0===c.selectedItems.length)c.varButtonLabel="undefined"!=typeof c.defaultLabel?c.defaultLabel:"None selected";else{var b=c.selectedItems.length;"undefined"!=typeof c.maxLabels&&""!==c.maxLabels&&(b=c.maxLabels),c.more=c.selectedItems.length>b?!0:!1,angular.forEach(c.selectedItems,function(a){"undefined"!=typeof a&&(ctr<b&&(c.varButtonLabel+=(c.varButtonLabel.length>0?'</div>, <div class="buttonLabel">':'<div class="buttonLabel">')+c.writeLabel(a,"buttonLabel")),ctr++)}),c.more===!0&&(b>0&&(c.varButtonLabel+=", ... "),c.varButtonLabel+="(Total: "+c.selectedItems.length+")")}c.varButtonLabel=a.trustAsHtml(c.varButtonLabel+'<span class="caret"></span>')},c.itemIsDisabled=function(a){return"undefined"!=typeof e.disableProperty&&a[c.disableProperty]===!0?!0:c.isDisabled===!0?!0:!1},c.writeLabel=function(b,d){var e="",f=c[d].split(" ");return angular.forEach(f,function(a){"undefined"!=typeof a&&angular.forEach(b,function(b,c){c==a&&(e+="&nbsp;"+b)})}),"BUTTONLABEL"===d.toUpperCase()?e:a.trustAsHtml(e)},c.toggleCheckboxes=function(a){if(c.checkBoxLayer=d.children()[1],clickedEl=d.children()[0],angular.element(document).unbind("click",c.externalClickListener),angular.element(document).unbind("keydown",c.keyboardListener),c.inputLabel.labelFilter="",c.updateFilter(),27===a.keyCode)return angular.element(c.checkBoxLayer).removeClass("show"),angular.element(clickedEl).removeClass("buttonClicked"),angular.element(document).unbind("click",c.externalClickListener),angular.element(document).unbind("keydown",c.keyboardListener),c.removeFocusStyle(c.tabIndex),c.onClose({data:d}),!0;if(angular.element(c.checkBoxLayer).hasClass("show"))angular.element(c.checkBoxLayer).removeClass("show"),angular.element(clickedEl).removeClass("buttonClicked"),angular.element(document).unbind("click",c.externalClickListener),angular.element(document).unbind("keydown",c.keyboardListener),c.removeFocusStyle(c.tabIndex),c.onClose({data:d});else{helperItems=[],helperItemsLength=0,angular.element(c.checkBoxLayer).addClass("show"),angular.element(clickedEl).addClass("buttonClicked"),angular.element(document).bind("click",c.externalClickListener),angular.element(document).bind("keydown",c.keyboardListener),c.getFormElements(),c.tabIndex=0;var b=angular.element(d[0].querySelector(".helperContainer"))[0];if("undefined"!=typeof b){for(i=0;i<b.getElementsByTagName("BUTTON").length;i++)helperItems[i]=b.getElementsByTagName("BUTTON")[i];helperItemsLength=helperItems.length+b.getElementsByTagName("INPUT").length}d[0].querySelector(".inputFilter")?(d[0].querySelector(".inputFilter").focus(),c.tabIndex=c.tabIndex+helperItemsLength-2):c.formElements[c.tabIndex].focus(),c.onOpen({data:d})}},c.externalClickListener=function(a){targetsArr=d.find(a.target.tagName);for(var e=0;e<targetsArr.length;e++)if(a.target==targetsArr[e])return;angular.element(c.checkBoxLayer.previousSibling).removeClass("buttonClicked"),angular.element(c.checkBoxLayer).removeClass("show"),angular.element(document).unbind("click",c.externalClickListener),angular.element(document).unbind("keydown",c.keyboardListener),b(function(){c.onClose({data:d})},0)},c.findUpTag=function(a,b,c){for(;a.parentNode;)if(a=a.parentNode,"undefined"!=typeof a.tagName&&a.tagName.toUpperCase()===b.toUpperCase()&&a.className.indexOf(c)>-1)return a;return null},c.select=function(a,b){switch(helperIndex=helperItems.indexOf(b.target),c.tabIndex=helperIndex,a.toUpperCase()){case"ALL":angular.forEach(c.filteredModel,function(a){"undefined"!=typeof a&&a[c.disableProperty]!==!0&&"undefined"==typeof a[c.groupProperty]&&(a[c.tickProperty]=!0)});break;case"NONE":angular.forEach(c.filteredModel,function(a){"undefined"!=typeof a&&a[c.disableProperty]!==!0&&"undefined"==typeof a[c.groupProperty]&&(a[c.tickProperty]=!1)});break;case"RESET":angular.forEach(c.filteredModel,function(a){"undefined"==typeof a[c.groupProperty]&&"undefined"!=typeof a&&a[c.disableProperty]!==!0&&(temp=a[c.indexProperty],a[c.tickProperty]=c.backUp[temp][c.tickProperty])});break;case"CLEAR":c.tabIndex=c.tabIndex+1;break;case"FILTER":c.tabIndex=helperItems.length-1}},genRandomString=function(a){for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",c="",d=0;a>d;d++)c+=b.charAt(Math.floor(Math.random()*b.length));return c},c.prepareGrouping=function(){var a=0;angular.forEach(c.filteredModel,function(b){b[c.spacingProperty]=a,b[c.groupProperty]===!0?a+=2:b[c.groupProperty]===!1&&(a-=2)})},c.prepareIndex=function(){ctr=0,angular.forEach(c.filteredModel,function(a){a[c.indexProperty]=ctr,ctr++})},c.keyboardListener=function(a){var b=a.keyCode?a.keyCode:a.which,d=!1;if(27===b)c.toggleCheckboxes(a);else if(40===b||39===b||!a.shiftKey&&9==b)for(d=!0,prevTabIndex=c.tabIndex,c.tabIndex++,c.tabIndex>c.formElements.length-1&&(c.tabIndex=0,prevTabIndex=c.formElements.length-1);c.formElements[c.tabIndex].disabled===!0;)c.tabIndex++,c.tabIndex>c.formElements.length-1&&(c.tabIndex=0);else if(38===b||37===b||a.shiftKey&&9==b)for(d=!0,prevTabIndex=c.tabIndex,c.tabIndex--,c.tabIndex<0&&(c.tabIndex=c.formElements.length-1,prevTabIndex=0);c.formElements[c.tabIndex].disabled===!0;)c.tabIndex--,c.tabIndex<0&&(c.tabIndex=c.formElements.length-1);if(d===!0){a.preventDefault(),a.stopPropagation(),c.formElements[c.tabIndex].focus();var e=document.activeElement;"CHECKBOX"===e.type.toUpperCase()?(c.setFocusStyle(c.tabIndex),c.removeFocusStyle(prevTabIndex)):(c.removeFocusStyle(prevTabIndex),c.removeFocusStyle(helperItemsLength),c.removeFocusStyle(c.formElements.length-1))}d=!1},c.setFocusStyle=function(a){angular.element(c.formElements[a]).parent().parent().parent().addClass("multiSelectFocus")},c.removeFocusStyle=function(a){angular.element(c.formElements[a]).parent().parent().parent().removeClass("multiSelectFocus")};var f=genRandomString(5);c.indexProperty="idx_"+f,c.spacingProperty="spc_"+f,"undefined"!=typeof e.orientation&&("HORIZONTAL"===e.orientation.toUpperCase()?(c.orientationH=!0,c.orientationV=!1):(c.orientationH=!1,c.orientationV=!0)),c.$watch("inputModel",function(a){a&&(c.refreshSelectedItems(),c.refreshOutputModel(),c.refreshButton(),null!==c.clickedItem&&b(function(){c.onItemClick({data:c.clickedItem}),c.clickedItem=null},0))},!0),c.$watch("inputModel",function(a){a&&(c.backUp=angular.copy(c.inputModel),c.updateFilter(),c.prepareGrouping(),c.prepareIndex(),c.refreshSelectedItems(),c.refreshOutputModel(),c.refreshButton())}),c.$watch("isDisabled",function(a){c.isDisabled=a}),angular.element(document).bind("touchstart",function(){c.$apply(function(){c.scrolled=!1})}),angular.element(document).bind("touchmove",function(){c.$apply(function(){c.scrolled=!0})}),Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){b=b||0;for(var c=this.length;c>b;){if(this[b]===a)return b;++b}return-1})}}}]);